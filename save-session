#!/bin/bash
# Claude Session Saver - Save your work before closing Claude Code
# Usage: save-session [--quick] [--away] [--suggest]
# shellcheck disable=SC2034  # Unused variables are for future features

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Config
SESSION_LOG="$HOME/.claude/session-saves/$(date +%Y-%m-%d_%H-%M-%S).md"

# Flags
FULL_MODE=false
QUICK_MODE=false
AWAY_MODE=false
SUGGEST_MODE=false

for arg in "$@"; do
    case $arg in
        --full) FULL_MODE=true ;;
        --quick) QUICK_MODE=true ;;
        --away) AWAY_MODE=true ;;
        --suggest) SUGGEST_MODE=true ;;
    esac
done

echo -e "${PURPLE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${PURPLE}‚ïë      üîÑ Claude Session Saver                         ‚ïë${NC}"
echo -e "${PURPLE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""

# Create session log directory
mkdir -p "$(dirname "$SESSION_LOG")"

# Start session log
cat > "$SESSION_LOG" << EOF
# Session Save - $(date '+%Y-%m-%d %H:%M:%S')

## Projects Checked

EOF

# Track status
ALL_SAVED=true
REPOS_CREATED=0
COMMITS_MADE=0
ISSUES_CREATED=0

# Function to check a directory
check_project() {
    local dir="$1"
    local name
    name=$(basename "$dir")

    # Skip if not a git repo and no significant files
    if [[ ! -d "$dir/.git" ]]; then
        # Check if it has code files worth saving
        local has_code
        has_code=$(find "$dir" -maxdepth 2 -type f \( -name "*.swift" -o -name "*.ts" -o -name "*.tsx" -o -name "*.py" -o -name "*.rs" -o -name "*.go" -o -name "*.java" \) 2>/dev/null | head -1)
        if [[ -z "$has_code" ]]; then
            return
        fi

        echo -e "${YELLOW}üìÅ $name - No git repo${NC}"

        if [[ "$QUICK_MODE" != "true" ]]; then
            echo -e "   Creating git repo and GitHub remote..."
            cd "$dir"
            git init -q
            git add -A
            git commit -q -m "Initial commit - session save $(date +%Y-%m-%d)"

            # Create GitHub repo
            if gh repo create "$name" --private --source . --push -y &>/dev/null; then
                echo -e "   ${GREEN}‚úì Created private repo: $name${NC}"
                ((REPOS_CREATED++))
                echo "- **$name**: Created new repo" >> "$SESSION_LOG"
            else
                echo -e "   ${RED}‚úó Failed to create repo${NC}"
                ALL_SAVED=false
            fi
        fi
        return
    fi

    cd "$dir"

    # Check for uncommitted changes
    local status
    status=$(git status --porcelain 2>/dev/null)
    local remote
    remote=$(git remote get-url origin 2>/dev/null || echo "")
    local branch
    branch=$(git branch --show-current 2>/dev/null || echo "main")

    if [[ -z "$status" && -n "$remote" ]]; then
        # Check if pushed
        local ahead
        # shellcheck disable=SC1083
        ahead=$(git rev-list --count '@{u}'..HEAD 2>/dev/null || echo "0")
        if [[ "$ahead" == "0" ]]; then
            echo -e "${GREEN}‚úì $name${NC} - All saved"
            echo "- **$name**: ‚úÖ All saved (branch: $branch)" >> "$SESSION_LOG"
            return
        fi
    fi

    echo -e "${YELLOW}üìÅ $name${NC}"

    # No remote? Create GitHub repo
    if [[ -z "$remote" ]]; then
        echo -e "   ${CYAN}No GitHub remote - creating...${NC}"
        if gh repo create "$name" --private --source . --push -y &>/dev/null; then
            echo -e "   ${GREEN}‚úì Created private repo${NC}"
            ((REPOS_CREATED++))
            remote=$(git remote get-url origin 2>/dev/null)
        else
            echo -e "   ${RED}‚úó Failed to create repo${NC}"
            ALL_SAVED=false
            echo "- **$name**: ‚ùå Failed to create repo" >> "$SESSION_LOG"
            return
        fi
    fi

    # Uncommitted changes?
    if [[ -n "$status" ]]; then
        local changed
        changed=$(echo "$status" | wc -l | tr -d ' ')
        echo -e "   ${YELLOW}$changed uncommitted changes${NC}"

        # Create save branch
        local save_branch
        save_branch="session-save/$(date +%Y-%m-%d-%H%M)"
        git checkout -b "$save_branch" 2>/dev/null || git checkout "$save_branch" 2>/dev/null || true

        git add -A
        git commit -q -m "Session save $(date '+%Y-%m-%d %H:%M')

Auto-saved by claude-session-saver
Changes: $changed files

## Status at save time:
$(git status --short)"

        ((COMMITS_MADE++))
        echo -e "   ${GREEN}‚úì Committed to $save_branch${NC}"
    fi

    # Push
    if git push -u origin HEAD &>/dev/null; then
        echo -e "   ${GREEN}‚úì Pushed to GitHub${NC}"
        echo "- **$name**: ‚úÖ Saved to branch \`$save_branch\` ([repo]($remote))" >> "$SESSION_LOG"
    else
        echo -e "   ${RED}‚úó Failed to push${NC}"
        ALL_SAVED=false
        echo "- **$name**: ‚ùå Failed to push" >> "$SESSION_LOG"
    fi

    # Go back to original branch
    git checkout "$branch" 2>/dev/null || true
}

# Check current directory (where Claude Code is running)
echo -e "${BLUE}Checking current directory...${NC}"
check_project "$(pwd)"

echo ""

# Summary
echo -e "${PURPLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
if [[ "$ALL_SAVED" == "true" ]]; then
    echo -e "${GREEN}‚úÖ All work saved! You can close Claude Code.${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Some projects need attention (see above)${NC}"
fi

echo ""
echo -e "üìä Summary:"
echo -e "   Repos created: $REPOS_CREATED"
echo -e "   Commits made:  $COMMITS_MADE"
echo -e "   Session log:   $SESSION_LOG"

# Add summary to log
cat >> "$SESSION_LOG" << EOF

## Summary
- Repos created: $REPOS_CREATED
- Commits made: $COMMITS_MADE
- All saved: $ALL_SAVED

## To Resume
\`\`\`bash
# View this session
cat "$SESSION_LOG"

# List all session saves
ls -la ~/.claude/session-saves/
\`\`\`
EOF

# ============================================================================
# SUGGESTIONS - Things to consider before closing
# ============================================================================

suggest_before_close() {
    local suggestions=()
    local dir="$1"

    cd "$dir" 2>/dev/null || return

    if [[ ! -d ".git" ]]; then
        return
    fi

    # Check for stashed changes
    local stash_count
    stash_count=$(git stash list 2>/dev/null | wc -l | tr -d ' ')
    if [[ "$stash_count" -gt 0 ]]; then
        suggestions+=("üì¶ You have $stash_count stash(es) - run 'git stash list' to review")
    fi

    # Check for unpushed commits
    local unpushed
    # shellcheck disable=SC1083
    unpushed=$(git rev-list --count '@{u}'..HEAD 2>/dev/null || echo "0")
    if [[ "$unpushed" -gt 0 ]]; then
        suggestions+=("‚¨ÜÔ∏è  $unpushed unpushed commit(s) on current branch")
    fi

    # Check for local branches without remote
    local local_only
    local_only=$(git branch -vv 2>/dev/null | grep -v '\[' | grep -cv '^\*' || echo "0")
    if [[ "$local_only" -gt 0 ]]; then
        suggestions+=("üåø $local_only local branch(es) not pushed to remote")
    fi

    # Check for open PRs (if gh is available)
    if command -v gh &>/dev/null; then
        local open_prs
        open_prs=$(gh pr list --author "@me" --state open 2>/dev/null | wc -l | tr -d ' ')
        if [[ "$open_prs" -gt 0 ]]; then
            suggestions+=("üîÑ You have $open_prs open PR(s) - run 'gh pr list' to review")
        fi
    fi

    # Check for TODO/FIXME comments added recently
    local todos
    todos=$(git diff HEAD~5 --unified=0 2>/dev/null | grep -c "TODO\|FIXME\|XXX\|HACK" || echo "0")
    if [[ "$todos" -gt 0 ]]; then
        suggestions+=("üìù ~$todos TODO/FIXME comments in recent commits")
    fi

    # Print suggestions
    if [[ ${#suggestions[@]} -gt 0 ]]; then
        echo ""
        echo -e "${CYAN}üí° Before you close:${NC}"
        for suggestion in "${suggestions[@]}"; do
            echo -e "   $suggestion"
        done
    fi
}

# ============================================================================
# AWAY MODE - Background tasks that can run while you're away
# ============================================================================

suggest_away_tasks() {
    local dir="$1"
    local tasks=()

    cd "$dir" 2>/dev/null || return

    echo ""
    echo -e "${PURPLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${CYAN}‚òï Away Mode - Tasks that can run while you're gone:${NC}"
    echo ""

    # Detect project type and suggest relevant tasks
    if [[ -f "package.json" ]]; then
        # Node.js project
        if grep -q '"test"' package.json 2>/dev/null; then
            tasks+=("üß™ Run tests: npm test")
        fi
        if grep -q '"lint"' package.json 2>/dev/null; then
            tasks+=("‚ú® Run linter: npm run lint")
        fi
        if grep -q '"build"' package.json 2>/dev/null; then
            tasks+=("üî® Build project: npm run build")
        fi
        tasks+=("üì¶ Update dependencies: npm update")
        tasks+=("üîí Security audit: npm audit")
    fi

    if [[ -f "requirements.txt" ]] || [[ -f "pyproject.toml" ]] || [[ -f "setup.py" ]]; then
        # Python project
        if [[ -f "pytest.ini" ]] || [[ -d "tests" ]]; then
            tasks+=("üß™ Run tests: pytest")
        fi
        tasks+=("‚ú® Run linter: ruff check . --fix")
        tasks+=("üîí Security audit: pip-audit")
    fi

    if [[ -f "Cargo.toml" ]]; then
        # Rust project
        tasks+=("üß™ Run tests: cargo test")
        tasks+=("‚ú® Run linter: cargo clippy")
        tasks+=("üî® Build release: cargo build --release")
        tasks+=("üîí Security audit: cargo audit")
    fi

    if [[ -f "go.mod" ]]; then
        # Go project
        tasks+=("üß™ Run tests: go test ./...")
        tasks+=("‚ú® Run linter: golangci-lint run")
        tasks+=("üî® Build: go build ./...")
    fi

    # Git-related tasks (universal)
    if [[ -d ".git" ]]; then
        # Check if there's a PR
        if command -v gh &>/dev/null; then
            local pr_number
            pr_number=$(gh pr view --json number -q '.number' 2>/dev/null || echo "")
            if [[ -n "$pr_number" ]]; then
                tasks+=("üëÄ Monitor PR #$pr_number: gh pr checks")
            else
                tasks+=("üöÄ Create PR: gh pr create --fill")
            fi
        fi

        # Suggest rebasing if behind main
        local behind
        behind=$(git rev-list --count HEAD..origin/main 2>/dev/null || echo "0")
        if [[ "$behind" -gt 0 ]]; then
            tasks+=("üîÑ Rebase on main ($behind commits behind): git rebase origin/main")
        fi

        tasks+=("üìä Fetch latest: git fetch --all --prune")
    fi

    # GitHub Actions (if present)
    if [[ -d ".github/workflows" ]]; then
        tasks+=("ü§ñ View CI status: gh run list --limit 5")
    fi

    # Docker (if present)
    if [[ -f "Dockerfile" ]]; then
        tasks+=("üê≥ Build Docker image: docker build -t \$(basename \$PWD) .")
    fi

    # Print tasks
    if [[ ${#tasks[@]} -gt 0 ]]; then
        echo -e "${YELLOW}Suggested tasks for this project:${NC}"
        echo ""
        for i in "${!tasks[@]}"; do
            echo -e "   $((i+1)). ${tasks[$i]}"
        done
        echo ""
        echo -e "${BLUE}üí° Tip: Push your changes, then these can run in CI while you're away${NC}"
    else
        echo -e "   No specific tasks detected for this project type"
    fi
}

# ============================================================================
# MAIN FLOW CONTINUES
# ============================================================================

# Show suggestions if not in quick mode
if [[ "$QUICK_MODE" != "true" ]]; then
    suggest_before_close "$(pwd)"
fi

# Show away mode tasks
if [[ "$AWAY_MODE" == "true" ]] || [[ "$SUGGEST_MODE" == "true" ]]; then
    suggest_away_tasks "$(pwd)"
fi

echo ""
if [[ "$ALL_SAVED" == "true" ]]; then
    echo -e "${GREEN}üëã Safe to close!${NC}"
else
    echo -e "${YELLOW}Review the issues above before closing.${NC}"
fi
